<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads dos formulários Urba</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        body {
            background: linear-gradient(120deg, #f8fafc 0%, #e2eafc 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        }
        .container {
            margin-top: 3rem;
            margin-bottom: 3rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card-custom {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
            padding: 2.5rem 2rem 2rem 2rem;
            max-width: 1100px;
            width: 100%;
        }
        h1 {
            text-align: center;
            margin-bottom: 2.5rem;
            font-weight: 800;
            letter-spacing: 1px;
            color: #22223b;
        }
        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
        }
        table {
            margin-bottom: 0;
            width: 100%;
        }
        th {
            background: #22223b;
            color: #fff;
            font-weight: 600;
            font-size: 1.08rem;
            letter-spacing: 0.5px;
            border: none;
            padding: 1rem;
            white-space: nowrap;
        }
        tr {
            transition: background 0.2s;
        }
        tr:hover {
            background: #e9ecef !important;
        }
        td {
            background: #fff;
            font-size: 1rem;
            color: #22223b;
            border: none;
            padding: 1rem;
            vertical-align: middle;
        }
        /* Alinhamento específico para cada coluna */
        td:nth-child(1), /* Nome */
        th:nth-child(1) {
            text-align: left;
            min-width: 200px;
        }
        td:nth-child(2), /* WhatsApp */
        th:nth-child(2) {
            text-align: center;
            min-width: 140px;
        }
        td:nth-child(3), /* Email */
        th:nth-child(3) {
            text-align: left;
            min-width: 250px;
        }
        td:nth-child(4), /* Parcelas */
        th:nth-child(4) {
            text-align: center;
            min-width: 100px;
        }
        td:nth-child(5), /* Data */
        th:nth-child(5) {
            text-align: center;
            min-width: 130px;
        }
        .data-cell {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2b2d42;
            padding: 0.5rem;
        }
        .data-header {
            background-color: #2b2d42 !important;
        }
        .data-destaque {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.4;
            padding: 0.3rem 0;
        }
        .data-dia {
            font-size: 1.1rem;
            color: #2b2d42;
            font-weight: 700;
        }
        .data-hora {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 2px;
        }
        @media (max-width: 900px) {
            .card-custom {
                padding: 1rem 0.2rem;
            }
            th {
                padding: 0.8rem;
                font-size: 1rem;
            }
            td {
                padding: 0.8rem;
                font-size: 0.95rem;
            }
        }
        @media (max-width: 600px) {
            h1 {
                font-size: 1.3rem;
            }
            .card-custom {
                padding: 0.5rem 0.1rem 1rem 0.1rem;
            }
        }
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-count {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card-custom">
            <h1>Leads dos formulários Urba</h1>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead>
                        <tr id="tableHeader">
                            <!-- Cabeçalhos serão inseridos dinamicamente -->
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dados serão inseridos dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="notification">
        Novo lead recebido!
    </div>
    <div class="notification-count">0</div>

    <!-- Audio para notificação -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        // Configuração do Socket.IO com reconexão automática
        const socket = io({
            path: '/socket.io',
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 10000,
            timeout: 60000,
            autoConnect: true,
            forceNew: true,
            withCredentials: true,
            extraHeaders: {
                "my-custom-header": "abcd"
            }
        });

        let isConnected = false;
        let reconnectAttempts = 0;
        let baseUrl = window.location.origin;

        function handleConnectionError() {
            console.log('Tentando reconectar...');
            if (!isConnected) {
                toastr.warning('Tentando reconectar ao servidor...', 'Conexão perdida');
                setTimeout(() => {
                    if (!isConnected) {
                        reconnectAttempts++;
                        console.log('Tentativa de reconexão:', reconnectAttempts);
                        socket.connect();
                        // Tentar recarregar os dados
                        carregarDados();
                    }
                }, Math.min(5000 * reconnectAttempts, 30000));
            }
        }

        const notificationSound = document.getElementById('notificationSound');
        const notification = document.getElementById('notification');
        const notificationCount = document.querySelector('.notification-count');
        let unreadCount = 0;

        // Eventos do Socket.IO
        socket.on('connect', () => {
            console.log('Conectado ao servidor Socket.IO');
            isConnected = true;
            reconnectAttempts = 0;
            toastr.success('Conectado ao servidor de notificações', 'Conexão estabelecida');
            // Solicitar dados iniciais
            socket.emit('requestInitialData');
        });

        socket.on('disconnect', (reason) => {
            console.log('Desconectado do servidor Socket.IO. Razão:', reason);
            isConnected = false;
            toastr.warning('Conexão com servidor perdida. Tentando reconectar...', 'Desconectado');
            handleConnectionError();
        });

        socket.on('connect_error', (error) => {
            console.error('Erro de conexão:', error);
            isConnected = false;
            handleConnectionError();
        });

        socket.on('error', (error) => {
            console.error('Erro no Socket.IO:', error);
            toastr.error('Erro na conexão: ' + (error.message || 'Erro desconhecido'), 'Erro');
        });

        // Configuração do Toastr
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        // Função para mostrar notificação
        function showNotification(lead) {
            try {
                // Tocar som
                notificationSound.play().catch(e => console.log('Erro ao tocar som:', e));

                // Mostrar notificação toast
                toastr.success(`Novo lead recebido de ${lead.nome}!`, 'Novo Lead!');

                // Incrementar contador
                unreadCount++;
                notificationCount.style.display = 'flex';
                notificationCount.textContent = unreadCount;

                // Adicionar o novo lead à tabela
                const headers = Object.keys(lead).filter(h => h !== '_id' && h !== 'tipoLote' && h !== 'aceitoPrivacidade' && h !== '__v');
                const newRow = document.createElement('tr');
                newRow.style.animation = 'highlight 2s';
                newRow.innerHTML = headers.map(header => {
                    if(header === 'dataEnvio') {
                        return `<td class="data-cell">${formatarData(lead[header])}</td>`;
                    }
                    return `<td>${lead[header]}</td>`;
                }).join('');
                
                // Adicionar a nova linha no topo da tabela
                const tableBody = document.getElementById('tableBody');
                if (tableBody.firstChild) {
                    tableBody.insertBefore(newRow, tableBody.firstChild);
                } else {
                    tableBody.appendChild(newRow);
                }

            } catch (error) {
                console.error('Erro ao mostrar notificação:', error);
                toastr.error('Erro ao mostrar notificação', 'Erro');
            }
        }

        // Listener para novos leads
        socket.on('novoLead', (lead) => {
            console.log('Novo lead recebido via Socket.IO:', lead);
            showNotification(lead);
        });

        // Listener para dados iniciais
        socket.on('initialData', (dados) => {
            console.log('Dados iniciais recebidos');
            renderizarDados(dados.reverse());
        });

        // Resetar contador ao clicar na página
        document.addEventListener('click', () => {
            unreadCount = 0;
            notificationCount.style.display = 'none';
        });

        // Mapeamento para nomes amigáveis
        const nomesCampos = {
            nome: 'Nome',
            whatsapp: 'WhatsApp',
            email: 'E-mail',
            parcelas: 'Parcelas',
            dataEnvio: 'Data de Envio'
        };

        function formatarData(dataISO) {
            if (!dataISO) return '';
            const data = new Date(dataISO);
            if (isNaN(data.getTime())) return dataISO;
            
            const dia = data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const hora = data.toLocaleString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            return `<div class="data-destaque">
                        <span class="data-dia">${dia}</span>
                        <span class="data-hora">${hora}</span>
                    </div>`;
        }

        async function carregarDados() {
            try {
                console.log('Iniciando carregamento de dados...');
                const response = await fetch(`${baseUrl}/api/dados`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || 'Erro desconhecido'}`);
                }

                const dados = await response.json();
                console.log('Dados carregados com sucesso:', dados);

                if (!dados || dados.length === 0) {
                    console.log('Nenhum dado encontrado');
                    document.getElementById('tableBody').innerHTML = '<tr><td colspan="5" class="text-center">Nenhum lead cadastrado ainda</td></tr>';
                    return;
                }

                renderizarDados(dados.reverse());
                toastr.success('Dados carregados com sucesso!', 'Sucesso');
            } catch (error) {
                console.error('Erro detalhado ao carregar dados:', error);
                toastr.error(`Erro ao carregar os dados: ${error.message}`, 'Erro');
                
                // Tentar recarregar após um tempo progressivo
                setTimeout(() => {
                    console.log('Tentando recarregar dados...');
                    carregarDados();
                }, Math.min(5000 * reconnectAttempts, 30000));
            }
        }

        function renderizarDados(dados) {
            if (!dados || dados.length === 0) {
                console.log('Sem dados para renderizar');
                return;
            }

            const headers = Object.keys(dados[0]).filter(h => h !== '_id' && h !== 'tipoLote' && h !== 'aceitoPrivacidade' && h !== '__v');
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = headers.map(header => 
                `<th class="${header === 'dataEnvio' ? 'data-header' : ''}">${nomesCampos[header] || header}</th>`
            ).join('');

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = dados.map(item => `
                <tr>
                    ${headers.map(header => {
                        if(header === 'dataEnvio') {
                            return `<td class="data-cell">${formatarData(item[header])}</td>`;
                        }
                        return `<td>${item[header]}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html> 